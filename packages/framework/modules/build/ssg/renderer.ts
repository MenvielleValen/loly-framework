import fs from "fs";
import path from "path";
import { renderToString } from "react-dom/server";
import type { LoadedRoute, LoaderResult, ServerContext } from "@router/index";
import {
  buildAppTree,
  buildInitialData,
  createDocumentTree,
} from "@rendering/index";
import { pathToOutDir } from "./path";
import { ensureDir } from "../utils";

/**
 * Renders a static page for SSG.
 * 
 * Executes middlewares and loader, then renders the React component tree
 * to HTML. Writes both the HTML file and the data JSON file.
 * 
 * @param projectRoot - Root directory of the project
 * @param ssgOutDir - SSG output directory
 * @param route - Route definition
 * @param urlPath - URL path for this page
 * @param params - Route parameters
 * 
 * @example
 * await renderStaticRoute(
 *   '/project',
 *   '/project/.fw/ssg',
 *   route,
 *   '/blog/my-post',
 *   { slug: 'my-post' }
 * );
 */
export async function renderStaticRoute(
  projectRoot: string,
  ssgOutDir: string,
  route: LoadedRoute,
  urlPath: string,
  params: Record<string, string>
): Promise<void> {
  console.log(`[framework][ssg] Generating ${urlPath}`);

  // Mock request/response objects for SSG
  const req: any = {
    method: "GET",
    headers: {},
    query: {},
    path: urlPath,
  };

  const res: any = {
    statusCode: 200,
    headers: {} as Record<string, string>,
    setHeader(name: string, value: string) {
      this.headers[name.toLowerCase()] = value;
    },
    get headersSent() {
      return false;
    },
  };

  const ctx: ServerContext = {
    req,
    res,
    params,
    pathname: urlPath,
    locals: {},
  };

  // Execute middlewares
  for (const mw of route.middlewares) {
    await Promise.resolve(
      mw(ctx, async () => {
        /* no-op */
      })
    );
  }

  // Execute loader
  let loaderResult: LoaderResult = { props: {} };

  if (route.loader) {
    loaderResult = await route.loader(ctx);
  }

  // Skip pages that redirect or return 404 during build
  if (loaderResult.redirect) {
    console.warn(
      `[framework][ssg] Route ${urlPath} returned redirect during build, skipping SSG.`
    );
    return;
  }
  if (loaderResult.notFound) {
    console.warn(
      `[framework][ssg] Route ${urlPath} returned notFound during build, skipping.`
    );
    return;
  }

  // Build React component tree
  const initialData = buildInitialData(urlPath, params, loaderResult);
  const appTree = buildAppTree(route, params, initialData.props);
  const documentTree = createDocumentTree({
    appTree,
    initialData,
    meta: loaderResult.metadata,
    titleFallback: "My Framework Dev",
    descriptionFallback: "Static page generated by @loly/core.",
  });

  // Render to HTML (hydratable, same as SSR)
  const html = "<!DOCTYPE html>" + renderToString(documentTree);

  // Write files
  const dir = pathToOutDir(ssgOutDir, urlPath);
  ensureDir(dir);

  const htmlFile = path.join(dir, "index.html");
  const dataFile = path.join(dir, "data.json");

  fs.writeFileSync(htmlFile, html, "utf-8");
  fs.writeFileSync(dataFile, JSON.stringify(initialData, null, 2), "utf-8");
}

